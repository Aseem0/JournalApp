@page "/entry"
@page "/entry/{Id:int}"
@using System.Text.RegularExpressions
@inject DatabaseService Db
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject ThemeService Theme

@if (_isEntryLoaded)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="pa-6">
        <!-- Header Section -->
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <div>
                <MudText Typo="Typo.h4" Style="font-weight: 600;">
                    @_entry.EntryDate.ToString("dddd, MMMM dd, yyyy")
                </MudText>
                <MudText Typo="Typo.body2">
                    @_wordCount words
                </MudText>
            </div>

            <MudStack Row="true" Spacing="2">
                @if (Id.HasValue)
                {
                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               Style="border-radius: 8px; text-transform: none;"
                               OnClick="HandleDeleteAsync">
                        Delete
                    </MudButton>
                }
                <MudButton Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Save"
                           Style="background-color: #fff; color: black; text-transform: none; border-radius: 8px;"
                           OnClick="HandleSaveAsync">
                    Save
                </MudButton>
            </MudStack>
        </MudStack>

        <!-- Mood and Tags Row -->
        <MudStack Row="true" Spacing="2" Class="mb-4" Style="flex-wrap: wrap;">
            <MudButton Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.EmojiEmotions"
                       Style="@GetMoodButtonStyle()"
                       OnClick="OpenMoodDialog">
                Mood: @_entry.PrimaryMood
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.LocalOffer"
                       Style="border-radius: 20px; text-transform: none; border-color: #444;"
                       OnClick="OpenTagDialog">
                @_entry.TagList.Count tag@(_entry.TagList.Count != 1 ? "s" : "")
            </MudButton>

            @foreach (var tag in _entry.TagList)
            {
                <MudChip T="string" Text="@tag"
                         Size="Size.Medium"
                         Style="border: 1px solid #444; border-radius: 16px;" />
            }
        </MudStack>

        <!-- Secondary Moods -->
        @if (_secondaryMoods.Any())
        {
            <MudStack Row="true" Spacing="2" Class="mb-4" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.body2">Secondary moods:</MudText>
                @foreach (var mood in _secondaryMoods)
                {
                    <MudChip T="string" Text="@mood"
                             Size="Size.Small"
                             Style="border: 1px solid #444; border-radius: 16px;" />
                }
            </MudStack>
        }

        <!-- Journal Content -->
        <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444; min-height: 400px;">
            <div id="quill-editor" style="height: 350px;"></div>
        </MudPaper>
    </MudContainer>
}
else
{
    <div class="d-flex justify-center align-center" style="height: 300px;">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
    </div>
}

<!-- Mood Selection Dialog -->
<MudDialog @bind-Visible="_showMoodDialog" Options="_dialogOptions">
    <TitleContent>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">Select Mood</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseMoodDialog" />
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <div>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Primary Mood</MudText>
                
                <MudText Typo="Typo.body2" Class="mb-2" Style="color: #999; font-size: 12px;">Positive</MudText>
                <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;" Class="mb-3">
                    @foreach (var mood in _positiveMoods)
                    {
                        <MudChip T="string" Text="@mood"
                                 OnClick="() => SelectPrimaryMood(mood)"
                                 Style="@GetMoodChipStyle(mood, _entry.PrimaryMood)"
                                 Size="Size.Medium" />
                    }
                </MudStack>

                <MudText Typo="Typo.body2" Class="mb-2" Style="color: #999; font-size: 12px;">Neutral</MudText>
                <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;" Class="mb-3">
                    @foreach (var mood in _neutralMoods)
                    {
                        <MudChip T="string" Text="@mood"
                                 OnClick="() => SelectPrimaryMood(mood)"
                                 Style="@GetMoodChipStyle(mood, _entry.PrimaryMood)"
                                 Size="Size.Medium" />
                    }
                </MudStack>

                <MudText Typo="Typo.body2" Class="mb-2" Style="color: #999; font-size: 12px;">Negative</MudText>
                <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                    @foreach (var mood in _negativeMoods)
                    {
                        <MudChip T="string" Text="@mood"
                                 OnClick="() => SelectPrimaryMood(mood)"
                                 Style="@GetMoodChipStyle(mood, _entry.PrimaryMood)"
                                 Size="Size.Medium" />
                    }
                </MudStack>
            </div>

            <div>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Secondary Moods (up to 2)</MudText>
                <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                    @foreach (var mood in _allMoods.Where(m => m != _entry.PrimaryMood))
                    {
                        <MudChip T="string" Text="@mood"
                                 OnClick="() => ToggleSecondaryMood(mood)"
                                 Style="@GetSecondaryMoodChipStyle(mood)"
                                 Size="Size.Medium" />
                    }
                </MudStack>
            </div>
        </MudStack>
    </DialogContent>
</MudDialog>

<!-- Tag Management Dialog -->
<MudDialog @bind-Visible="_showTagDialog" Options="_dialogOptions">
    <TitleContent>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">Manage Tags</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseTagDialog" />
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <div>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Predefined Tags</MudText>
                <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                    @foreach (var tag in _predefinedTags)
                    {
                        <MudChip T="string" Text="@tag"
                                 OnClick="() => ToggleTag(tag)"
                                 Style="@GetTagChipStyle(tag)"
                                 Size="Size.Medium" />
                    }
                </MudStack>
            </div>

            <div>
                <MudText Typo="Typo.subtitle1" Class="mb-2" Style="color: #666;">Add Custom Tag</MudText>
                <MudStack Row="true" Spacing="2">
                    <MudTextField T="string"
                                 @bind-Value="_customTagInput"
                                 Placeholder="Enter tag name"
                                 Variant="Variant.Outlined"
                                 Style="flex: 1;" />
                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                                  Variant="Variant.Filled"
                                  Style="background-color: #fff; color: black; border-radius: 8px;"
                                  OnClick="AddCustomTag" />
                </MudStack>
            </div>

            @if (_entry.TagList.Any())
            {
                <div>
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Selected Tags</MudText>
                    <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                        @foreach (var tag in _entry.TagList)
                        {
                            <MudChip T="string" Text="@tag"
                                     OnClose="() => RemoveTag(tag)"
                                     Size="Size.Medium"
                                     Style="border: 1px solid #444; border-radius: 16px;" />
                        }
                    </MudStack>
                </div>
            }
        </MudStack>
    </DialogContent>
</MudDialog>

@code {
    [Parameter] public int? Id { get; set; }

    // --- State Management ---
    private JournalItem _entry = new();
    private bool _isEntryLoaded;
    private int _wordCount;
    private bool _needsEditorUpdate;
    private DotNetObjectReference<TodaysEntry>? _objRef;

    // --- Mood Data ---
    private bool _showMoodDialog;
    private List<string> _secondaryMoods = [];
    private readonly List<string> _positiveMoods = ["Happy", "Excited", "Grateful", "Peaceful", "Proud", "Hopeful"];
    private readonly List<string> _neutralMoods = ["Calm", "Thoughtful", "Curious", "Neutral", "Content"];
    private readonly List<string> _negativeMoods = ["Sad", "Anxious", "Angry", "Frustrated", "Tired", "Lonely"];
    private readonly List<string> _allMoods = [];

    // --- Tag Data ---
    private bool _showTagDialog;
    private string _customTagInput = string.Empty;
    private readonly List<string> _predefinedTags = ["Work", "Health", "Travel", "Fitness", "Personal", "Goals", "Family", "Relationships"];

    private readonly DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Small,
        FullWidth = true,
        CloseButton = false
    };

    protected override void OnInitialized()
    {
        _allMoods.AddRange(_positiveMoods);
        _allMoods.AddRange(_neutralMoods);
        _allMoods.AddRange(_negativeMoods);
    }

    /// <summary>
    /// Loads the entry based on the route Parameter (Id) or defaults to today's entry.
    /// </summary>
    protected override async Task OnParametersSetAsync()
    {
        _isEntryLoaded = false;
        
        if (Id.HasValue)
        {
            // Edit existing entry
            var existing = await Db.GetEntryByIdAsync(Id.Value);
            _entry = existing ?? CreateNewEntry();
            _needsEditorUpdate = true;
        }
        else
        {
            // Check if entry for today already exists
            var existingForToday = await Db.GetEntryByDateAsync(DateTime.Today);
            if (existingForToday != null)
            {
                Nav.NavigateTo($"/entry/{existingForToday.Id}");
                return;
            }

            _entry = CreateNewEntry();
            _needsEditorUpdate = true;
        }

        UpdateWordCount();
        _secondaryMoods = _entry.SecondaryMoodList;
        _isEntryLoaded = true;
    }

    private static JournalItem CreateNewEntry() => new()
    {
        EntryDate = DateTime.Today,
        CreatedAt = DateTime.Now,
        PrimaryMood = "Calm"
    };

    /// <summary>
    /// Strips HTML and counts space-separated words.
    /// </summary>
    private void UpdateWordCount()
    {
        if (string.IsNullOrWhiteSpace(_entry.Content))
        {
            _wordCount = 0;
            return;
        }

        var text = Regex.Replace(_entry.Content, "<.*?>", string.Empty);
        _wordCount = text.Split([' ', '\n', '\r'], StringSplitOptions.RemoveEmptyEntries).Length;
    }

    // --- CRUD Operations ---
    private async Task HandleSaveAsync()
    {
        if (string.IsNullOrWhiteSpace(_entry.Content))
        {
            Snackbar.Add("Please write something in your journal", Severity.Warning);
            return;
        }

        if (Id.HasValue)
        {
            await Db.UpdateEntryAsync(_entry);
            Snackbar.Add("Entry updated successfully", Severity.Success);
        }
        else
        {
            var existing = await Db.GetEntryByDateAsync(_entry.EntryDate);
            if (existing != null)
            {
                Snackbar.Add("An entry already exists for this date", Severity.Error);
                Nav.NavigateTo($"/entry/{existing.Id}");
                return;
            }

            await Db.SaveEntryAsync(_entry);
            Snackbar.Add("Entry saved successfully", Severity.Success);
        }

        Nav.NavigateTo("/timeline");
    }

    private async Task HandleDeleteAsync()
    {
        if (Id.HasValue)
        {
            await Db.DeleteEntryAsync(Id.Value);
            Snackbar.Add("Entry deleted successfully", Severity.Success);
            Nav.NavigateTo("/timeline");
        }
    }

    // --- Mood Selection Handlers ---
    private void OpenMoodDialog() => _showMoodDialog = true;
    private void CloseMoodDialog() => _showMoodDialog = false;

    private void SelectPrimaryMood(string mood)
    {
        _entry.PrimaryMood = mood;
        // Don't allow same mood in both primary and secondary
        if (_secondaryMoods.Contains(mood))
        {
            _secondaryMoods.Remove(mood);
            _entry.SecondaryMoodList = _secondaryMoods;
        }
    }

    private void ToggleSecondaryMood(string mood)
    {
        if (_secondaryMoods.Contains(mood))
        {
            _secondaryMoods.Remove(mood);
        }
        else if (_secondaryMoods.Count < 2)
        {
            _secondaryMoods.Add(mood);
        }
        _entry.SecondaryMoodList = _secondaryMoods;
    }

    private static string GetMoodButtonStyle() => "border-radius: 20px; text-transform: none; border-color: #444;";

    // Dynamic styling for mood chips
    private string GetMoodChipStyle(string mood, string selectedMood)
    {
        if (mood == selectedMood)
        {
            return Theme.IsDarkMode 
                ? "background-color: #ffffff; color: #000000; cursor: pointer; border-radius: 16px; font-weight: 600;" 
                : "background-color: #000000; color: #ffffff; cursor: pointer; border-radius: 16px; font-weight: 600;";
        }
        return "border: 1px solid #444; cursor: pointer; border-radius: 16px;";
    }

    private string GetSecondaryMoodChipStyle(string mood)
    {
        if (_secondaryMoods.Contains(mood))
        {
            return Theme.IsDarkMode 
                ? "background-color: #ffffff; color: #000000; cursor: pointer; border-radius: 16px; font-weight: 600;" 
                : "background-color: #000000; color: #ffffff; cursor: pointer; border-radius: 16px; font-weight: 600;";
        }
        return "border: 1px solid #444; cursor: pointer; border-radius: 16px;";
    }

    // --- Tag Management ---
    private void OpenTagDialog() => _showTagDialog = true;
    private void CloseTagDialog() => _showTagDialog = false;

    private void ToggleTag(string tag)
    {
        var tags = _entry.TagList;
        if (tags.Contains(tag))
        {
            tags.Remove(tag);
        }
        else
        {
            tags.Add(tag);
        }
        _entry.TagList = tags;
    }

    private void AddCustomTag()
    {
        if (string.IsNullOrWhiteSpace(_customTagInput)) return;

        var tags = _entry.TagList;
        if (!tags.Contains(_customTagInput))
        {
            tags.Add(_customTagInput);
            _entry.TagList = tags;
            _customTagInput = string.Empty;
        }
    }

    private void RemoveTag(string tag)
    {
        var tags = _entry.TagList;
        tags.Remove(tag);
        _entry.TagList = tags;
    }

    private string GetTagChipStyle(string tag)
    {
        if (_entry.TagList.Contains(tag))
        {
            return Theme.IsDarkMode 
                ? "background-color: #ffffff; color: #000000; cursor: pointer; border-radius: 16px; font-weight: 600;" 
                : "background-color: #000000; color: #ffffff; cursor: pointer; border-radius: 16px; font-weight: 600;";
        }
        return "border: 1px solid #444; cursor: pointer; border-radius: 16px;";
    }

    // --- Quill Rich Text Editor Interop ---
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_isEntryLoaded && _objRef == null)
        {
            // Initializing Quill editor after DOM is ready
            _objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("quillHelpers.initQuill", "quill-editor", _entry.Content, _objRef);
            _needsEditorUpdate = false;
        }
        else if (_isEntryLoaded && _objRef != null && _needsEditorUpdate)
        {
            // Syncing editor content when navigating between entries
            await JS.InvokeVoidAsync("quillHelpers.setQuillContent", _entry.Content);
            _needsEditorUpdate = false;
        }
    }

    /// <summary>
    /// JS callback to sync editor HTML with C# model.
    /// </summary>
    [JSInvokable]
    public void UpdateEntryContent(string htmlContent)
    {
        _entry.Content = htmlContent;
        UpdateWordCount();
        StateHasChanged();
    }

    public void Dispose() => _objRef?.Dispose();
}
