@implements IDisposable
@inject NavigationManager NavManager
@inject JournalApp.Services.ThemeService ThemeService
@using Microsoft.AspNetCore.Components.Routing

<MudPaper Elevation="0" Class="pa-4" Style="height: 100vh;">
    <div class="mb-6">
        <MudText Typo="Typo.h5" Style="font-weight: 600;">Journal</MudText>
        <MudText Typo="Typo.body2">Your personal space</MudText>
    </div>

    <MudStack Spacing="2">
        <MudButton Href="/"
                   Style="@GetButtonStyle("/")"     
                   StartIcon="@Icons.Material.Filled.Home"
                   FullWidth="true"
                   Variant="@(IsActive("/") ? Variant.Filled : Variant.Text)">
            Dashboard
        </MudButton>

        <MudButton Href="entry"
                   Style="@GetButtonStyle("entry")"
                   StartIcon="@Icons.Material.Filled.Edit"
                   FullWidth="true"
                   Variant="@(IsActive("entry") ? Variant.Filled : Variant.Text)">
            Today's Entry
        </MudButton>

        <MudButton Href="calendar"
                   Style="@GetButtonStyle("calendar")"
                   StartIcon="@Icons.Material.Filled.CalendarToday"
                   FullWidth="true"
                   Class="nav-button"
                   Variant="@(IsActive("calendar") ? Variant.Filled : Variant.Text)">
            Calendar
        </MudButton>

        <MudButton Href="timeline"
                   Style="@GetButtonStyle("timeline")"
                   StartIcon="@Icons.Material.Filled.AccessTime"
                   FullWidth="true"
                   Variant="@(IsActive("timeline") ? Variant.Filled : Variant.Text)">
            Timeline
        </MudButton>

        <MudButton Href="analytics"
                   Style="@GetButtonStyle("analytics")"
                   StartIcon="@Icons.Material.Filled.BarChart"
                   FullWidth="true"
                   Variant="@(IsActive("analytics") ? Variant.Filled : Variant.Text)">
            Analytics
        </MudButton>

        <MudButton Href="settings"
                   Style="@GetButtonStyle("settings")"
                   StartIcon="@Icons.Material.Filled.Settings"
                   FullWidth="true"
                   Variant="@(IsActive("settings") ? Variant.Filled : Variant.Text)">
            Settings
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    protected override void OnInitialized()
    {
        NavManager.LocationChanged += HandleLocationChanged;
        ThemeService.OnThemeChanged += RefreshUI;
    }

    private void RefreshUI() => InvokeAsync(StateHasChanged);

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        NavManager.LocationChanged -= HandleLocationChanged;
        ThemeService.OnThemeChanged -= RefreshUI;
    }

    private bool IsActive(string route)
    {
        var currentRoute = NavManager.Uri
            .Replace(NavManager.BaseUri, "")
            .Trim('/')
            .Split('?')[0]
            .Split('/')[0]
            .ToLower();

        if (route == "/" && string.IsNullOrEmpty(currentRoute))
            return true;

        return currentRoute == route.ToLower();
    }

    private string GetButtonStyle(string route)
    {
        if (IsActive(route))
        {
            if (ThemeService.IsDarkMode)
            {
                return "background-color: #fff !important; color: #000 !important; border-radius: 12px;" +
                       " text-transform: none; justify-content: flex-start;" +
                       " padding: 12px 16px; font-weight: 600;";
            }
            else
            {
                return "background-color: #0a0a0a !important; color: white !important; border-radius: 12px;" +
                       " text-transform: none; justify-content: flex-start;" +
                       " padding: 12px 16px; font-weight: 500;";
            }
        }

        return "text-transform: none; justify-content: flex-start; padding: 12px 16px; font-weight: 500;";
    }
}
