@page "/entry"
@page "/entry/{Id:int}"
@using JournalApp.Services
@using JournalApp.Models
@inject DatabaseService Db
@inject NavigationManager Nav

<MudText Typo="Typo.h4" Class="mb-4">@(Id.HasValue ? "Edit Entry" : "New Journal Entry")</MudText>

@if (EntryLoaded)
{
    <MudPaper Class="pa-6" Elevation="4">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudDatePicker Label="Entry Date" @bind-Date="_entryDate" Editable="true" Color="Color.Primary" />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudSelect T="string" Label="Overall Mood" @bind-Value="Entry.PrimaryMood" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("")">Select Mood</MudSelectItem>
                    <MudSelectItem Value="@("Happy")">Happy</MudSelectItem>
                    <MudSelectItem Value="@("Sad")">Sad</MudSelectItem>
                    <MudSelectItem Value="@("Calm")">Calm</MudSelectItem>
                    <MudSelectItem Value="@("Stressed")">Stressed</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Tags</MudText>
                <div class="d-flex align-center gap-4 flex-wrap">
                    <MudSelect T="string" Label="Select Predefined Tag" @bind-Value="SelectedTag" Dense="true" Style="width: 250px;" Variant="Variant.Outlined">
                        <MudSelectItem Value="@("")">Select Tag</MudSelectItem>
                        @foreach (var tag in AvailableTags)
                        {
                            <MudSelectItem Value="@tag">@tag</MudSelectItem>
                        }
                    </MudSelect>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="AddSelectedTag">Add</MudButton>

                    <MudDivider Vertical="true" FlexItem="true" />

                    <MudTextField T="string" Label="Custom Tag" @bind-Value="NewCustomTag" Dense="true" Style="width: 200px;" Variant="Variant.Outlined" />
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="AddCustomTag">Add</MudButton>
                </div>
            </MudItem>

            <MudItem xs="12">
                @if (Entry.TagList.Any())
                {
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        @foreach (var tag in Entry.TagList)
                        {
                            <MudChip T="string" OnClose="() => RemoveTag(tag)" Color="Color.Primary" Variant="Variant.Filled">@tag</MudChip>
                        }
                    </div>
                }
            </MudItem>

            <MudItem xs="12">
                <MudTextField T="string" Label="Your Thoughts" Variant="Variant.Outlined" Lines="8" @bind-Value="Entry.Content" Placeholder="Write your journal entry here..." AutoGrow />
            </MudItem>

            <MudItem xs="12" Class="d-flex justify-end mt-4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="Save" Size="Size.Large">Save Entry</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
}
else
{
    <div class="d-flex justify-center align-center" style="height: 300px;">
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }

    JournalItem Entry { get; set; } = new JournalItem();
    bool EntryLoaded { get; set; } = false;

    // MudDatePicker requires DateTime?
    private DateTime? _entryDate
    {
        get => Entry.EntryDate;
        set => Entry.EntryDate = value ?? DateTime.Today;
    }

    protected override void OnInitialized()
    {
        if (Id.HasValue)
        {
            // Try to get the entry, but ensure we always have a valid object
            var existing = Db.GetEntryById(Id.Value);
            Entry = existing ?? new JournalItem
            {
                EntryDate = DateTime.Today,
                CreatedAt = DateTime.Now
            };
        }
        else
        {
            Entry = new JournalItem
            {
                EntryDate = DateTime.Today,
                CreatedAt = DateTime.Now
            };
        }

        EntryLoaded = true; // now safe to bind
    }

    void Save()
    {
        if (Id.HasValue)
        {
            Db.UpdateEntry(Entry);
        }
        else
        {
            Db.SaveEntry(Entry);
        }

        Nav.NavigateTo("/timeline", true);
    }

    List<string> AvailableTags = new()
    {
        "Education",
        "Health",
        "Work",
        "Travel",
        "Family",
        "Finance",
        "Personal",
        "Fitness"
    };

    string SelectedTag = "";
    string NewCustomTag = "";

    void AddSelectedTag()
    {
        if (!string.IsNullOrWhiteSpace(SelectedTag))
        {
            var tags = Entry.TagList;

            if (!tags.Contains(SelectedTag))
            {
                tags.Add(SelectedTag);
                Entry.TagList = tags;
            }

            SelectedTag = "";
        }
    }

    void AddCustomTag()
    {
        if (!string.IsNullOrWhiteSpace(NewCustomTag))
        {
            var tags = Entry.TagList;

            if (!tags.Contains(NewCustomTag))
            {
                tags.Add(NewCustomTag);
                Entry.TagList = tags;
            }

            NewCustomTag = "";
        }
    }

    void RemoveTag(string tag)
    {
        var tags = Entry.TagList;
        tags.Remove(tag);
        Entry.TagList = tags;
    }
}
