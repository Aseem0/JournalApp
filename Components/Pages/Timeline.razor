@page "/timeline"
@using System.Text.RegularExpressions
@inject DatabaseService Db
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <div class="mb-6">
        <MudText Typo="Typo.h4" Style="font-weight: 600;">Timeline</MudText>
        <MudText Typo="Typo.body1">Browse all your journal entries</MudText>
    </div>

    <!-- Search Bar and Filters -->
    <MudStack Row="true" Spacing="3" Class="mb-6">
        <MudTextField @bind-Value="_searchQuery"
                     Placeholder="Search entries by title or content..."
                     Variant="Variant.Outlined"
                     Adornment="Adornment.Start"
                     AdornmentIcon="@Icons.Material.Filled.Search"
                     FullWidth="true"
                     Immediate="true"
                     Style="border-radius: 12px;"
                     @bind-Value:after="HandleFilterEntries" />
        
        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.FilterList"
                   OnClick="HandleOpenFilterDialog"
                   Style="border-radius: 12px; min-width: 120px; background-color: #fff; color: black; border-color: #fff; text-transform: none;">
            Filters
        </MudButton>
    </MudStack>

    <!-- Journal Entries List -->
    @if (_entries == null || _filteredEntries.Count == 0)
    {
        <MudPaper Elevation="0" Class="pa-8 text-center" Style="border-radius: 16px; border: 1px solid #444;">
            <MudText Typo="Typo.body1">No entries yet.</MudText>
        </MudPaper>
    }
    else
    {
        <MudStack Spacing="4">
            @foreach (var entry in _pagedEntries)
            {
                <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444; cursor: pointer;" @onclick="() => HandleEditEntry(entry.Id)">
                    <MudStack Spacing="3">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                    @entry.EntryDate.ToString("dddd, MMMM dd, yyyy")
                                </MudText>
                            </MudStack>
                            
                            <MudChip T="string" Text="@entry.PrimaryMood"
                                    Size="Size.Small"
                                    Style="@GetMoodChipStyle(entry.PrimaryMood)" />
                        </MudStack>

                        <MudText Typo="Typo.body1" Style="line-height: 1.6;">
                            @GetPreviewText(entry.Content)
                        </MudText>

                        @if (entry.TagList.Any())
                        {
                            <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                                @foreach (var tag in entry.TagList)
                                {
                                    <MudChip T="string" Text="@tag"
                                            Size="Size.Small"
                                            Variant="Variant.Outlined"
                                            Style="border-radius: 8px;" />
                                }
                            </MudStack>
                        }
                    </MudStack>
                </MudPaper>
            }
        </MudStack>

        <!-- Pagination Controls -->
        <MudStack Row="true" Justify="Justify.Center" AlignItems="AlignItems.Center" Class="mt-6">
            <MudButton Variant="Variant.Outlined" 
                       Disabled="@(_currentPage == 1)" 
                       OnClick="HandlePreviousPage"
                       StartIcon="@Icons.Material.Filled.ChevronLeft"
                       Style="border-radius: 8px;">
                Previous
            </MudButton>
            <MudText Typo="Typo.body2">Page @_currentPage of @Math.Max(1, _totalPages)</MudText>
            <MudButton Variant="Variant.Outlined" 
                       Disabled="@(_currentPage >= _totalPages)" 
                       OnClick="HandleNextPage"
                       EndIcon="@Icons.Material.Filled.ChevronRight"
                       Style="border-radius: 8px;">
                Next
            </MudButton>
        </MudStack>
    }
</MudContainer>

<!-- Filter Dialog -->
<MudDialog @bind-Visible="_isFilterDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">Filter Entries</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="HandleCloseFilterDialog" />
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <div>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Moods</MudText>
                <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                    @foreach (var mood in _availableMoods)
                    {
                        <MudChip T="string" Text="@mood"
                                Variant="@(_selectedMoods.Contains(mood) ? Variant.Filled : Variant.Outlined)"
                                Color="@(_selectedMoods.Contains(mood) ? Color.Primary : Color.Default)"
                                OnClick="() => ToggleMood(mood)"
                                Style="@(_selectedMoods.Contains(mood) ? "background-color: #0a0a0a; color: white;" : "")" />
                    }
                </MudStack>
            </div>

            <div>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Tags</MudText>
                @if (_availableTags.Any())
                {
                    <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                        @foreach (var tag in _availableTags)
                        {
                            <MudChip T="string" Text="@tag"
                                    Variant="@(_selectedTags.Contains(tag) ? Variant.Filled : Variant.Outlined)"
                                    Color="@(_selectedTags.Contains(tag) ? Color.Primary : Color.Default)"
                                    OnClick="() => ToggleTag(tag)"
                                    Style="@(_selectedTags.Contains(tag) ? "background-color: #0a0a0a; color: white;" : "")" />
                        }
                    </MudStack>
                }
                else
                {
                    <MudText Typo="Typo.body2" Style="color: #999;">No tags found.</MudText>
                }
            </div>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HandleClearFilters" Color="Color.Error">Clear All</MudButton>
        <MudButton OnClick="HandleApplyFilters" Color="Color.Primary" Variant="Variant.Filled">Apply Filters</MudButton>
    </DialogActions>
</MudDialog>

@code {
    // --- Data State ---
    private List<JournalItem>? _entries;
    private List<JournalItem> _filteredEntries = [];
    private List<JournalItem> _pagedEntries = [];
    private string _searchQuery = string.Empty;

    // --- Pagination State ---
    private int _currentPage = 1;
    private const int PageSize = 4;
    private int _totalPages = 1;

    // --- Filter State ---
    private bool _isFilterDialogVisible;
    private readonly HashSet<string> _selectedMoods = [];
    private readonly HashSet<string> _selectedTags = [];
    private List<string> _availableTags = [];
    private readonly List<string> _availableMoods = 
    [ 
        "Happy", "Excited", "Grateful", "Peaceful", "Proud", "Hopeful",
        "Calm", "Thoughtful", "Curious", "Neutral", "Content",
        "Sad", "Anxious", "Angry", "Frustrated", "Tired", "Lonely" 
    ];
    
    private readonly DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        // Load all entries once and then filter in-memory for speed
        _entries = (await Db.GetAllEntriesAsync()).ToList();
        _filteredEntries = _entries;
        HandleFilterEntries();
        
        // Extract all unique tags ever used for the filter list
        if (_entries != null)
        {
            _availableTags = _entries
                .SelectMany(e => e.TagList)
                .Distinct()
                .OrderBy(t => t)
                .ToList();
        }
    }

    // Filters the loaded entries based on search query, selected moods, and selected tags.
    private void HandleFilterEntries()
    {
        if (_entries == null) return;

        var query = _entries.AsEnumerable();

        // Filter by search text (stripping HTML first)
        if (!string.IsNullOrWhiteSpace(_searchQuery))
        {
            query = query.Where(e => Regex.Replace(e.Content, "<.*?>", string.Empty)
                                          .Contains(_searchQuery, StringComparison.OrdinalIgnoreCase));
        }

        // Filter by any of the selected moods
        if (_selectedMoods.Any())
        {
            query = query.Where(e => !string.IsNullOrEmpty(e.PrimaryMood) && _selectedMoods.Contains(e.PrimaryMood));
        }

        // Filter by any of the selected tags
        if (_selectedTags.Any())
        {
            query = query.Where(e => e.TagList.Any(t => _selectedTags.Contains(t)));
        }

        _filteredEntries = query.ToList();
        _currentPage = 1; // Reset to first page after filtering
        UpdatePagination();
    }

    // Slices the filtered list into the current page for display.
    private void UpdatePagination()
    {
        if (_filteredEntries.Count == 0)
        {
            _totalPages = 1;
            _pagedEntries.Clear();
        }
        else
        {
            _totalPages = (int)Math.Ceiling((double)_filteredEntries.Count / PageSize);
            _pagedEntries = _filteredEntries.Skip((_currentPage - 1) * PageSize).Take(PageSize).ToList();
        }
    }

    // --- Page Navigation Handlers ---
    private void HandlePreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            UpdatePagination();
        }
    }

    private void HandleNextPage()
    {
        if (_currentPage < _totalPages)
        {
            _currentPage++;
            UpdatePagination();
        }
    }

    // --- Filter Interaction Handlers ---
    private void HandleOpenFilterDialog() => _isFilterDialogVisible = true;
    private void HandleCloseFilterDialog() => _isFilterDialogVisible = false;
    
    private void ToggleMood(string mood)
    {
        if (!_selectedMoods.Remove(mood)) _selectedMoods.Add(mood);
    }
    
    private void ToggleTag(string tag)
    {
        if (!_selectedTags.Remove(tag)) _selectedTags.Add(tag);
    }

    private void HandleClearFilters()
    {
        _selectedMoods.Clear();
        _selectedTags.Clear();
        HandleFilterEntries();
    }

    private void HandleApplyFilters()
    {
        HandleFilterEntries();
        HandleCloseFilterDialog();
    }

    // Generates a plain-text snippet of the content for the timeline list.
    private static string GetPreviewText(string content)
    {
        if (string.IsNullOrEmpty(content)) return string.Empty;
        var plainText = Regex.Replace(content, "<.*?>", string.Empty);
        return plainText.Length > 200 ? plainText.Substring(0, 200) + "..." : plainText;
    }

    private static string GetMoodChipStyle(string mood)
    {
        var baseStyle = "border-radius: 8px; font-weight: 500;";
        return mood.ToLower() switch
        {
            "calm" or "happy" or "excited" or "positive" => baseStyle + " background-color: #d1fae5; color: #065f46;",
            "anxious" or "stressed" or "negative" => baseStyle + " background-color: #fee2e2; color: #991b1b;",
            "neutral" => baseStyle + " background-color: #fef3c7; color: #92400e;",
            _ => baseStyle + " background-color: #e5e7eb; color: #1f2937;"
        };
    }

    private void HandleEditEntry(int id) => Nav.NavigateTo($"/entry/{id}");
}
