@page "/"
@using System.Text.RegularExpressions
@using System.Net
@inject DatabaseService Db
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <div class="mb-6">
        <MudText Typo="Typo.h4" Style="font-weight: 600;">Welcome back</MudText>
        <MudText Typo="Typo.body1">Here's your journaling overview</MudText>
    </div>

    <MudGrid Spacing="4" Class="mb-6">
        <MudItem xs="12" md="4">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Start">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background-color: #fff4ed; display: flex; align-items: center; justify-content: center;">
                        <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" Style="color: #fb923c;" Size="Size.Medium" />
                    </div>
                    <div>
                        <MudText Typo="Typo.body2" Style="margin-bottom: 4px;">Current Streak</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">@_currentStreak days</MudText>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Start">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background-color: #eff6ff; display: flex; align-items: center; justify-content: center;">
                        <MudIcon Icon="@Icons.Material.Filled.TrackChanges" Style="color: #3b82f6;" Size="Size.Medium" />
                    </div>
                    <div>
                        <MudText Typo="Typo.body2" Style="margin-bottom: 4px;">Longest Streak</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">@_longestStreak days</MudText>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Start">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background-color: #faf5ff; display: flex; align-items: center; justify-content: center;">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Style="color: #a855f7;" Size="Size.Medium" />
                    </div>
                    <div>
                        <MudText Typo="Typo.body2" Style="margin-bottom: 4px;">Missed Days</MudText>
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">@_missedDays</MudText>
                    </div>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="0" Class="pa-6 mb-6" Style="border-radius: 16px; border: 1px solid #444;">
        <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600;">
            This Week's Mood
        </MudText>

        <MudGrid Spacing="4">
            <MudItem xs="12" md="4">
                <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 12px; border: 1px solid #333;">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #10b981;"></div>
                        <div>
                            <MudText Typo="Typo.body2">Positive</MudText>
                            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_positiveMoodCount</MudText>
                        </div>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 12px; border: 1px solid #333;">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #f59e0b;"></div>
                        <div>
                            <MudText Typo="Typo.body2">Neutral</MudText>
                            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_neutralMoodCount</MudText>
                        </div>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 12px; border: 1px solid #333;">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ef4444;"></div>
                        <div>
                            <MudText Typo="Typo.body2">Negative</MudText>
                            <MudText Typo="Typo.h6" Style="font-weight: 600;">@_negativeMoodCount</MudText>
                        </div>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h6" Style="font-weight: 600;">
                Recent Entries
            </MudText>
            <MudButton Variant="Variant.Text"
                      Style="text-transform: none;"
                      OnClick="HandleWriteNewEntry">
                Write today's entry
            </MudButton>
        </MudStack>

        <MudStack Spacing="3">
            @if (_recentEntries.Any())
            {
                @foreach (var entry in _recentEntries)
                {
                    <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 12px; border: 1px solid #333; cursor: pointer;" @onclick="() => HandleViewEntry(entry.Id)">
                        <MudStack Spacing="2">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                <MudText Typo="Typo.body2">
                                    @entry.EntryDate.ToString("dddd, MMMM dd, yyyy")
                                </MudText>
                            </MudStack>
                            <MudText Typo="Typo.body1" Style="line-height: 1.6;">
                                @GetPreviewText(entry.Content)
                            </MudText>
                        </MudStack>
                    </MudPaper>
                }
            }
            else
            {
                <MudText Typo="Typo.body2" Style="text-align: center; padding: 32px 0;">
                    No entries yet. Start writing your first journal entry!
                </MudText>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    // --- Dashboard State ---
    private int _currentStreak;
    private int _longestStreak;
    private int _missedDays;
    private int _positiveMoodCount;
    private int _neutralMoodCount;
    private int _negativeMoodCount;
    private List<JournalItem> _recentEntries = [];

    // --- Mood Categories for Analytics ---
    private readonly List<string> _positiveMoods = ["Happy", "Excited", "Grateful", "Peaceful", "Proud", "Hopeful", "Calm"];
    private readonly List<string> _neutralMoods = ["Thoughtful", "Curious", "Neutral", "Content"];
    private readonly List<string> _negativeMoods = ["Sad", "Anxious", "Angry", "Frustrated", "Tired", "Lonely", "Stressed"];

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardDataAsync();
    }

    /// <summary>
    /// Loads all necessary data for the dashboard overview.
    /// </summary>
    private async Task LoadDashboardDataAsync()
    {
        var allEntries = (await Db.GetAllEntriesAsync()).ToList();
        
        // Populate stats and recent entries list
        _recentEntries = allEntries.OrderByDescending(e => e.EntryDate).Take(3).ToList();
        _currentStreak = CalculateCurrentStreak(allEntries);
        _longestStreak = CalculateLongestStreak(allEntries);
        _missedDays = CalculateMissedDays(allEntries);
        CalculateWeeklyMoodDistribution(allEntries);
    }

    /// <summary>
    /// Calculates the current consecutive journaling streak.
    /// </summary>
    private static int CalculateCurrentStreak(List<JournalItem> entries)
    {
        if (!entries.Any()) return 0;

        var sortedDates = entries.Select(e => e.EntryDate.Date)
                                 .Distinct()
                                 .OrderByDescending(d => d)
                                 .ToList();
        
        var today = DateTime.Today;
        var latestEntry = sortedDates.First();

        // Streak is broken if the last entry isn't today or yesterday
        if (latestEntry != today && latestEntry != today.AddDays(-1))
            return 0;

        var streak = 1;
        for (var i = 0; i < sortedDates.Count - 1; i++)
        {
            if ((sortedDates[i] - sortedDates[i + 1]).TotalDays == 1)
            {
                streak++;
            }
            else
            {
                break;
            }
        }

        return streak;
    }

    /// <summary>
    /// Finds the historically longest journaling streak.
    /// </summary>
    private static int CalculateLongestStreak(List<JournalItem> entries)
    {
        if (!entries.Any()) return 0;

        var sortedDates = entries.OrderBy(e => e.EntryDate)
                                 .Select(e => e.EntryDate.Date)
                                 .Distinct()
                                 .ToList();
        var maxStreak = 1;
        var currentStreakCalc = 1;

        for (var i = 1; i < sortedDates.Count; i++)
        {
            if ((sortedDates[i] - sortedDates[i - 1]).TotalDays == 1)
            {
                currentStreakCalc++;
                maxStreak = Math.Max(maxStreak, currentStreakCalc);
            }
            else
            {
                currentStreakCalc = 1;
            }
        }

        return maxStreak;
    }

    /// <summary>
    /// Calculates how many days were missed since the first entry.
    /// </summary>
    private static int CalculateMissedDays(List<JournalItem> entries)
    {
        if (!entries.Any()) return 0;

        var entryDates = entries.Select(e => e.EntryDate.Date).ToHashSet();
        var firstEntryDate = entryDates.Min();
        var yesterday = DateTime.Today.AddDays(-1);

        if (firstEntryDate > yesterday) return 0;

        var totalDays = (yesterday - firstEntryDate).Days + 1;
        var entriesInPeriod = entryDates.Count(d => d >= firstEntryDate && d <= yesterday);

        return totalDays - entriesInPeriod;
    }

    /// <summary>
    /// Tallies the distribution of moods for the current week starting from Sunday.
    /// </summary>
    private void CalculateWeeklyMoodDistribution(List<JournalItem> entries)
    {
        var weekStart = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek);
        var thisWeekEntries = entries.Where(e => e.EntryDate >= weekStart).ToList();

        _positiveMoodCount = thisWeekEntries.Count(e => _positiveMoods.Contains(e.PrimaryMood));
        _neutralMoodCount = thisWeekEntries.Count(e => _neutralMoods.Contains(e.PrimaryMood));
        _negativeMoodCount = thisWeekEntries.Count(e => _negativeMoods.Contains(e.PrimaryMood));
    }

    // --- Navigation Handlers ---
    private void HandleWriteNewEntry() => Nav.NavigateTo("/entry");
    private void HandleViewEntry(int id) => Nav.NavigateTo($"/entry/{id}");

    /// <summary>
    /// Converts HTML content to plain text and truncates it for preview.
    /// </summary>
    private static string GetPreviewText(string html)
    {
        if (string.IsNullOrEmpty(html)) return string.Empty;
        var plainText = WebUtility.HtmlDecode(Regex.Replace(html, "<.*?>", string.Empty));
        return plainText.Length > 150 ? plainText.Substring(0, 150) + "..." : plainText;
    }
}
