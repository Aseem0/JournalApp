@page "/settings"
@inject DatabaseService Db
@inject ISnackbar Snackbar
@inject ThemeService Theme
@inject SecurityService Security
@inject PdfExportService PdfService
@inject CommunityToolkit.Maui.Storage.IFileSaver FileSaver
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <div class="mb-6">
        <MudText Typo="Typo.h4" Style="font-weight: 600;">Settings</MudText>
        <MudText Typo="Typo.body1">Manage your journal preferences</MudText>
    </div>

    <MudStack Spacing="4">
        <!-- Appearance Section -->
        <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
            <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600;">
                Appearance
            </MudText>

            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.LightMode" Size="Size.Medium" />
                    <div>
                        <MudText Typo="Typo.body1" Style="font-weight: 500;">Theme</MudText>
                        <MudText Typo="Typo.body2">@(Theme.IsDarkMode ? "Dark mode" : "Light mode")</MudText>
                    </div>
                </MudStack>

                <MudButton Variant="Variant.Outlined"
                          Style="border-radius: 8px; text-transform: none; border-color: #444;"
                          OnClick="HandleToggleThemeAsync">
                    @(Theme.IsDarkMode ? "Switch to Light" : "Switch to Dark")
                </MudButton>
            </MudStack>
        </MudPaper>

        <!-- Security & Privacy Section -->
        <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
            <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600;">
                Security & Privacy
            </MudText>

            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Medium" />
                    <div>
                        <MudText Typo="Typo.body1" Style="font-weight: 500;">PIN Protection</MudText>
                        <MudText Typo="Typo.body2">Secure your journal with a PIN</MudText>
                    </div>
                </MudStack>

                <MudStack Row="true" Spacing="2">
                    @if (_hasPinSet)
                    {
                        <MudButton Variant="Variant.Outlined"
                                  Style="border-radius: 8px; text-transform: none; border-color: #ef4444; color: #ef4444;"
                                  OnClick="HandleRemovePinAsync">
                            Remove PIN
                        </MudButton>
                    }
                    <MudButton Variant="Variant.Outlined"
                               Style="border-radius: 8px; text-transform: none; border-color: #444;"
                               OnClick="HandleOpenPinDialog">
                        @(_hasPinSet ? "Change PIN" : "Set PIN")
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>

        <!-- Export Data Section -->
        <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
            <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600;">
                Export Data
            </MudText>

            <MudGrid Spacing="3">
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2" Class="mb-2">Start Date</MudText>
                    <MudDatePicker @bind-Date="_startDate"
                                  Placeholder="mm/dd/yyyy"
                                  Variant="Variant.Outlined"
                                  Style="border-radius: 8px;" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.body2" Class="mb-2">End Date</MudText>
                    <MudDatePicker @bind-Date="_endDate"
                                  Placeholder="mm/dd/yyyy"
                                  Variant="Variant.Outlined"
                                  Style="border-radius: 8px;" />
                </MudItem>
            </MudGrid>

            <MudButton Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Download"
                       Style="background-color: #0a0a0a; color: white; text-transform: none; border-radius: 8px; margin-top: 16px;"
                       OnClick="HandleExportAsPdfAsync">
                Export as PDF
            </MudButton>

            <MudText Typo="Typo.body2" Class="mt-3">
                Export your journal entries within the specified date range as a PDF file
            </MudText>
        </MudPaper>

        <!-- Data Management Section -->
        <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
            <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600;">
                Data Management
            </MudText>

            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Medium" Style="color: #ef4444;" />
                    <div>
                        <MudText Typo="Typo.body1" Style="font-weight: 500;">Clear All Data</MudText>
                        <MudText Typo="Typo.body2">Permanently delete all journal entries</MudText>
                    </div>
                </MudStack>

                <MudButton Variant="Variant.Outlined"
                          Style="border-radius: 8px; text-transform: none; border-color: #ef4444; color: #ef4444;"
                          OnClick="HandleOpenDeleteDialog">
                    Delete All
                </MudButton>
            </MudStack>
        </MudPaper>

        <!-- About Section -->
        <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
            <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600;">
                About
            </MudText>

            <MudStack Spacing="2">
                <MudText Typo="Typo.body2">
                    <strong>Version 1.0.0</strong>
                </MudText>
                <MudText Typo="Typo.body2">
                    All data is stored locally on your device.
                </MudText>
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

<!-- Delete Confirmation Dialog -->
<MudDialog @bind-Visible="_showDeleteDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Confirm Delete All Data</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Are you sure you want to permanently delete all journal entries? This action cannot be undone.</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HandleCloseDeleteDialog" Style="text-transform: none;">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="HandleDeleteAllDataAsync" Style="text-transform: none;">
            Delete All
        </MudButton>
    </DialogActions>
</MudDialog>

<!-- PIN Dialog -->
<MudDialog @bind-Visible="_showPinDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@(_hasPinSet ? "Change PIN" : "Set PIN")</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_pinInput"
                     Label="Enter 4-Digit PIN"
                     Variant="Variant.Outlined"
                     InputType="InputType.Password"
                     MaxLength="4"
                     FullWidth="true"
                     Class="mb-3" />
        <MudTextField @bind-Value="_confirmPinInput"
                     Label="Confirm 4-Digit PIN"
                     Variant="Variant.Outlined"
                     InputType="InputType.Password"
                     MaxLength="4"
                     FullWidth="true" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="HandleClosePinDialog" Style="text-transform: none;">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandleSavePinAsync" Style="text-transform: none;">
            Save PIN
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    // --- Local State ---
    private bool _hasPinSet;
    private DateTime? _startDate;
    private DateTime? _endDate;
    private bool _showDeleteDialog;
    private bool _showPinDialog;
    private string _pinInput = string.Empty;
    private string _confirmPinInput = string.Empty;

    private readonly DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Small,
        FullWidth = true,
        CloseButton = true
    };

    protected override async Task OnInitializedAsync()
    {
        Theme.ThemeChanged += StateHasChanged;
        _hasPinSet = await Security.IsPinSetAsync();
    }

    // --- Appearance Handlers ---
    private async Task HandleToggleThemeAsync()
    {
        await Theme.ToggleThemeAsync();
        Snackbar.Add($"Switched to {(Theme.IsDarkMode ? "Dark" : "Light")} mode", Severity.Success);
    }

    // --- PIN Management Handlers ---
    private void HandleOpenPinDialog()
    {
        _pinInput = string.Empty;
        _confirmPinInput = string.Empty;
        _showPinDialog = true;
    }

    private void HandleClosePinDialog() => _showPinDialog = false;

    private async Task HandleSavePinAsync()
    {
        // Simple 4-digit numeric validation
        if (_pinInput.Length != 4 || !_pinInput.All(char.IsDigit))
        {
            Snackbar.Add("PIN must be exactly 4 digits", Severity.Error);
            return;
        }

        if (_pinInput != _confirmPinInput)
        {
            Snackbar.Add("PINs do not match", Severity.Error);
            return;
        }

        await Security.SetPinAsync(_pinInput);
        _hasPinSet = true;
        _showPinDialog = false;
        Snackbar.Add("PIN saved successfully", Severity.Success);
    }

    private async Task HandleRemovePinAsync()
    {
        await Security.SetPinAsync(string.Empty);
        _hasPinSet = false;
        Snackbar.Add("PIN removed", Severity.Success);
    }

    // --- Data Export Logic ---
    // Generates and saves a PDF containing all entries within the selected date range.
    private async Task HandleExportAsPdfAsync()
    {
        if (!_startDate.HasValue || !_endDate.HasValue)
        {
            Snackbar.Add("Please select both start and end dates", Severity.Warning);
            return;
        }

        if (_startDate > _endDate)
        {
            Snackbar.Add("Start date must be before end date", Severity.Error);
            return;
        }

        try
        {
            var allEntries = (await Db.GetAllEntriesAsync()).ToList();
            var filtered = allEntries
                .Where(e => e.EntryDate.Date >= _startDate.Value.Date && e.EntryDate.Date <= _endDate.Value.Date)
                .ToList();

            if (!filtered.Any())
            {
                Snackbar.Add("No journal entries found in this range", Severity.Info);
                return;
            }

            // Generate binary PDF data
            var pdfBytes = PdfService.GenerateJournalPdf(filtered);
            using var stream = new MemoryStream(pdfBytes);
            var fileName = $"MyJournal_{_startDate.Value:yyyyMMdd}_{_endDate.Value:yyyyMMdd}.pdf";
            
            // Invoke MAUI FileSaver to let the user choose a save location
            var result = await FileSaver.SaveAsync(fileName, stream, default);
            if (result.IsSuccessful) Snackbar.Add("Journal exported successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
    }

    // --- Data Deletion Handlers ---
    private void HandleOpenDeleteDialog() => _showDeleteDialog = true;
    private void HandleCloseDeleteDialog() => _showDeleteDialog = false;

    private async Task HandleDeleteAllDataAsync()
    {
        await Db.DeleteAllEntriesAsync();
        _showDeleteDialog = false;
        Snackbar.Add("All data deleted successfully", Severity.Success);
    }

    public void Dispose() => Theme.ThemeChanged -= StateHasChanged;
}
