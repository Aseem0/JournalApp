@page "/calendar"
@inject DatabaseService Db
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <!-- Header with Month/Year and Navigation -->
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
        <MudText Typo="Typo.h4" Style="font-weight: 600;">
            @_currentDate.ToString("MMMM yyyy")
        </MudText>
        <MudStack Row="true" Spacing="2">
            <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                          OnClick="HandlePreviousMonth"
                          Style="border: 1px solid #e0e0e0; border-radius: 8px;"
                          Size="Size.Medium" />
            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                          OnClick="HandleNextMonth"
                          Style="border: 1px solid #e0e0e0; border-radius: 8px;"
                          Size="Size.Medium" />
        </MudStack>
    </MudStack>

    <!-- Calendar Grid -->
    <MudPaper Elevation="0" Class="pa-4" Style="border-radius: 16px; border: 1px solid #444;">
        <MudGrid Spacing="3" Class="mb-2">
            @foreach (var day in _dayHeaders)
            {
                <MudItem xs="12" sm="12" md="1" Style="min-width: 140px;">
                    <MudText Typo="Typo.body2" Align="Align.Center" Style="font-weight: 500;">
                        @day
                    </MudText>
                </MudItem>
            }
        </MudGrid>

        <MudGrid Spacing="3">
            @foreach (var day in _calendarDays)
            {
                <MudItem xs="12" sm="12" md="1" Style="min-width: 140px;">
                    <MudPaper Elevation="0" 
                             Class="pa-4 d-flex flex-column align-center justify-center"
                             Style="@GetDayStyle(day)"
                             @onclick="() => HandleSelectDay(day)">
                        <MudText Typo="Typo.body1" Style="@GetDayTextStyle(day)">
                            @(day.Date.Day)
                        </MudText>
                        @if (day.Mood.HasValue)
                        {
                            <div style="@($"width: 8px; height: 8px; border-radius: 50%; background-color: {GetMoodColor(day.Mood.Value)}; margin-top: 8px;")"></div>
                        }
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    <!-- Mood Legend -->
    <MudPaper Elevation="0" Class="pa-6 mt-6" Style="border-radius: 16px; border: 1px solid #444;">
        <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600;">
            Mood Legend
        </MudText>
        <MudStack Row="true" Spacing="6">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #10b981;"></div>
                <MudText Typo="Typo.body2">Positive</MudText>
            </MudStack>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #f59e0b;"></div>
                <MudText Typo="Typo.body2">Neutral</MudText>
            </MudStack>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <div style="width: 12px; height: 12px; border-radius: 50%; background-color: #ef4444;"></div>
                <MudText Typo="Typo.body2">Negative</MudText>
            </MudStack>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    // --- Calendar State ---
    private DateTime _currentDate = new(DateTime.Now.Year, DateTime.Now.Month, 1);
    private DateTime? _selectedDate;
    private List<CalendarDay> _calendarDays = [];
    private readonly string[] _dayHeaders = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    // --- Enums and Models ---
    public enum MoodType { Positive, Neutral, Negative }

    public class CalendarDay
    {
        public DateTime Date { get; init; }
        public bool IsCurrentMonth { get; init; }
        public bool IsSelected { get; set; }
        public MoodType? Mood { get; init; }
        public int? EntryId { get; init; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCalendarDaysAsync();
    }

    // Generates a 42-day calendar grid based on the current visible month.
    // Includes trailing/leading days from adjacent months.
    private async Task LoadCalendarDaysAsync()
    {
        _calendarDays.Clear();
        var firstDayOfMonth = new DateTime(_currentDate.Year, _currentDate.Month, 1);
        
        // Find the Sunday of the week containing the 1st of the month
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        
        var allEntries = await Db.GetAllEntriesAsync(); 

        // Always show 6 weeks (42 days) for a consistent grid
        for (var i = 0; i < 42; i++)
        {
            var date = startDate.AddDays(i);
            var entry = allEntries.FirstOrDefault(e => e.EntryDate.Date == date.Date);

            _calendarDays.Add(new CalendarDay
            {
                Date = date,
                IsCurrentMonth = date.Month == _currentDate.Month,
                IsSelected = _selectedDate.HasValue && date.Date == _selectedDate.Value.Date,
                Mood = entry != null ? MapMood(entry.PrimaryMood) : null,
                EntryId = entry?.Id
            });
        }
    }

    // Maps a string mood name to a MoodType category for simplified calendar display.
    private static MoodType? MapMood(string moodName)
    {
        if (string.IsNullOrEmpty(moodName)) return null;

        var positive = new[] { "Happy", "Excited", "Grateful", "Peaceful", "Proud", "Hopeful" };
        var neutral = new[] { "Calm", "Thoughtful", "Curious", "Neutral", "Content" };
        var negative = new[] { "Sad", "Anxious", "Angry", "Frustrated", "Tired", "Lonely" };

        if (positive.Contains(moodName)) return MoodType.Positive;
        if (neutral.Contains(moodName)) return MoodType.Neutral;
        if (negative.Contains(moodName)) return MoodType.Negative;

        return MoodType.Neutral;
    }

    // --- Styling Helpers ---
    private string GetDayStyle(CalendarDay day)
    {
        var baseStyle = "min-height: 120px; border-radius: 12px; cursor: pointer; transition: all 0.2s;";
        
        if (day.IsSelected) return baseStyle + " border: 2px solid #fff;";
        if (!day.IsCurrentMonth) return baseStyle + " border: 1px solid transparent;";
        
        return baseStyle + " border: 1px solid #444;";
    }

    private string GetDayTextStyle(CalendarDay day)
    {
        return day.IsCurrentMonth ? "font-weight: 500;" : "color: #555; font-weight: 500;";
    }

    private static string GetMoodColor(MoodType mood) => mood switch
    {
        MoodType.Positive => "#10b981",
        MoodType.Neutral => "#f59e0b",
        MoodType.Negative => "#ef4444",
        _ => "#e5e7eb"
    };

    // --- Interaction Handlers ---
    private void HandleSelectDay(CalendarDay day)
    {
        _selectedDate = day.Date;
        foreach (var d in _calendarDays)
        {
            d.IsSelected = d.Date == _selectedDate;
        }

        // Navigate to entry if one exists for the selected day
        if (day.EntryId.HasValue)
        {
            Nav.NavigateTo($"/entry/{day.EntryId}");
        }
    }

    private async Task HandlePreviousMonth()
    {
        _currentDate = _currentDate.AddMonths(-1);
        await LoadCalendarDaysAsync();
    }

    private async Task HandleNextMonth()
    {
        _currentDate = _currentDate.AddMonths(1);
        await LoadCalendarDaysAsync();
    }
}
