@page "/timeline"
@using JournalApp.Models
@using JournalApp.Services
@inject DatabaseService Db
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <!-- Header -->
    <div class="mb-6">
        <MudText Typo="Typo.h4" Style="font-weight: 600;">Timeline</MudText>
        <MudText Typo="Typo.body1">Browse all your journal entries</MudText>
    </div>

    <!-- Search Bar and Filters -->
    <MudStack Row="true" Spacing="3" Class="mb-6">
        <MudTextField @bind-Value="searchQuery"
                     Placeholder="Search entries by title or content..."
                     Variant="Variant.Outlined"
                     Adornment="Adornment.Start"
                     AdornmentIcon="@Icons.Material.Filled.Search"
                     FullWidth="true"
                     Immediate="true"
                     Style="border-radius: 12px;"
                     @bind-Value:after="FilterEntries" />
        
        <MudButton Variant="Variant.Outlined"
           StartIcon="@Icons.Material.Filled.FilterList"
           OnClick="OpenFilterDialog"
           Style="border-radius: 12px;
                  min-width: 120px;
                  background-color: #fff;
                  color: black;
                  border-color: #fff;
                  text-transform: none;">
            Filters
        </MudButton>
    </MudStack>

    <!-- Journal Entries List -->
    @if (Entries == null || FilteredEntries.Count == 0)
    {
        <MudPaper Elevation="0" Class="pa-8 text-center" Style="border-radius: 16px; border: 1px solid #444;">
            <MudText Typo="Typo.body1">No entries yet.</MudText>
        </MudPaper>
    }
    else
    {
        <MudStack Spacing="4">
            @foreach (var entry in PagedEntries)
            {
                <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444; cursor: pointer;" @onclick="() => EditEntry(entry.Id)">
                    <MudStack Spacing="3">
                        <!-- Date and Mood Badge -->
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                    @entry.EntryDate.ToString("dddd, MMMM dd, yyyy")
                                </MudText>
                            </MudStack>
                            
                                <MudChip T="string" Text="@entry.PrimaryMood"
                                    Size="Size.Small"
                                    Style="@GetMoodChipStyle(entry.PrimaryMood)" />
                        </MudStack>

                        <!-- Entry Content Preview -->
                        <MudText Typo="Typo.body1" Style="line-height: 1.6;">
                            @GetPreviewText(entry.Content)
                        </MudText>

                        <!-- Tags -->
                        @if (entry.TagList?.Any() == true)
                        {
                            <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                                @foreach (var tag in entry.TagList)
                                {
                                    <MudChip T="string" Text="@tag"
                                    Size="Size.Small"
                                    Variant="Variant.Outlined"
                                    Style="border-radius: 8px;" />
                                }
                            </MudStack>
                        }


                    </MudStack>
                </MudPaper>
            }
        </MudStack>

        <!-- Pagination Controls -->
        <MudStack Row="true" Justify="Justify.Center" AlignItems="AlignItems.Center" Class="mt-6">
            <MudButton Variant="Variant.Outlined" 
                       Disabled="@(currentPage == 1)" 
                       OnClick="PreviousPage"
                       StartIcon="@Icons.Material.Filled.ChevronLeft"
                       Style="border-radius: 8px;">
                Previous
            </MudButton>
            <MudText Typo="Typo.body2">Page @currentPage of @Math.Max(1, totalPages)</MudText>
            <MudButton Variant="Variant.Outlined" 
                       Disabled="@(currentPage >= totalPages)" 
                       OnClick="NextPage"
                       EndIcon="@Icons.Material.Filled.ChevronRight"
                       Style="border-radius: 8px;">
                Next
            </MudButton>
        </MudStack>
    }
    </MudContainer>

    <!-- Filter Dialog -->
    <MudDialog @bind-Visible="isFilterDialogVisible" Options="dialogOptions">
        <TitleContent>
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h6">Filter Entries</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseFilterDialog" />
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudStack Spacing="4">
                <!-- Moods -->
                <div>
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Moods</MudText>
                    <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                        @foreach (var mood in availableMoods)
                        {
                            <MudChip T="string" Text="@mood"
                                    Variant="@(selectedMoods.Contains(mood) ? Variant.Filled : Variant.Outlined)"
                                    Color="@(selectedMoods.Contains(mood) ? Color.Primary : Color.Default)"
                                    OnClick="() => ToggleMood(mood)"
                                    Style="@(selectedMoods.Contains(mood) ? "background-color: #0a0a0a; color: white;" : "")" />
                        }
                    </MudStack>
                </div>

                <!-- Tags -->
                <div>
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Tags</MudText>
                    @if (availableTags.Any())
                    {
                        <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                            @foreach (var tag in availableTags)
                            {
                                <MudChip T="string" Text="@tag"
                                        Variant="@(selectedTags.Contains(tag) ? Variant.Filled : Variant.Outlined)"
                                        Color="@(selectedTags.Contains(tag) ? Color.Primary : Color.Default)"
                                        OnClick="() => ToggleTag(tag)"
                                        Style="@(selectedTags.Contains(tag) ? "background-color: #0a0a0a; color: white;" : "")" />
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Style="color: #999;">No tags found.</MudText>
                    }
                </div>
            </MudStack>
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="ClearFilters" Color="Color.Error">Clear All</MudButton>
            <MudButton OnClick="ApplyFilters" Color="Color.Primary" Variant="Variant.Filled">Apply Filters</MudButton>
        </DialogActions>
    </MudDialog>

@code {
    List<JournalItem>? Entries;
    List<JournalItem> FilteredEntries = new();
    List<JournalItem> PagedEntries = new();
    string searchQuery = "";

    // Pagination State
    int currentPage = 1;
    int pageSize = 4;
    int totalPages = 1;

    // Filter State
    bool isFilterDialogVisible;
    HashSet<string> selectedMoods = new();
    HashSet<string> selectedTags = new();
    List<string> availableTags = new();
    List<string> availableMoods = new() 
    { 
        "Happy", "Excited", "Grateful", "Peaceful", "Proud", "Hopeful",
        "Calm", "Thoughtful", "Curious", "Neutral", "Content",
        "Sad", "Anxious", "Angry", "Frustrated", "Tired", "Lonely" 
    };
    
    DialogOptions dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override void OnInitialized()
    {
        Entries = Db.GetEntries();
        FilteredEntries = Entries ?? new List<JournalItem>();
        FilterEntries(); // Initial filter/pagination logic
        
        // Extract all unique tags
        if (Entries != null)
        {
            availableTags = Entries
                .Where(e => e.TagList != null)
                .SelectMany(e => e.TagList)
                .Distinct()
                .OrderBy(t => t)
                .ToList();
        }
    }

    void FilterEntries()
    {
        if (Entries == null) return;

        var query = Entries.AsEnumerable();

        // 1. Filter by Search Query (Content only)
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            query = query.Where(entry =>
            {
                var plainContent = System.Text.RegularExpressions.Regex.Replace(entry.Content ?? "", "<.*?>", string.Empty, System.Text.RegularExpressions.RegexOptions.Singleline);
                return plainContent.Contains(searchQuery, StringComparison.OrdinalIgnoreCase);
            });
        }

        // 2. Filter by Moods
        if (selectedMoods.Any())
        {
            query = query.Where(entry => !string.IsNullOrEmpty(entry.PrimaryMood) && selectedMoods.Contains(entry.PrimaryMood));
        }

        // 3. Filter by Tags
        if (selectedTags.Any())
        {
            query = query.Where(entry => entry.TagList != null && entry.TagList.Any(t => selectedTags.Contains(t)));
        }

        FilteredEntries = query.ToList();
        
        // Reset Pagination
        currentPage = 1;
        UpdatePagination();
    }

    void UpdatePagination()
    {
        if (FilteredEntries.Count == 0)
        {
            totalPages = 1;
            PagedEntries.Clear();
        }
        else
        {
            totalPages = (int)Math.Ceiling((double)FilteredEntries.Count / pageSize);
            PagedEntries = FilteredEntries.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
        }
    }

    void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            UpdatePagination();
        }
    }

    void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            UpdatePagination();
        }
    }

    // Filter Dialog Methods
    void OpenFilterDialog() => isFilterDialogVisible = true;
    void CloseFilterDialog() => isFilterDialogVisible = false;
    
    void ToggleMood(string mood)
    {
        if (selectedMoods.Contains(mood)) selectedMoods.Remove(mood);
        else selectedMoods.Add(mood);
    }
    
    void ToggleTag(string tag)
    {
        if (selectedTags.Contains(tag)) selectedTags.Remove(tag);
        else selectedTags.Add(tag);
    }

    void ClearFilters()
    {
        selectedMoods.Clear();
        selectedTags.Clear();
        FilterEntries();
        // Keep dialog open or close? User usually expects clear to just clear selection.
    }

    void ApplyFilters()
    {
        FilterEntries();
        CloseFilterDialog();
    }

    string GetPreviewText(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", string.Empty);
        return plainText.Length > 200 ? plainText.Substring(0, 200) + "..." : plainText;
    }

    string GetMoodChipStyle(string mood)
    {
        var baseStyle = "border-radius: 8px; font-weight: 500;";
        
        return mood.ToLower() switch
        {
            "calm" or "happy" or "excited" or "positive" => baseStyle + " background-color: #d1fae5; color: #065f46;",
            "anxious" or "stressed" or "negative" => baseStyle + " background-color: #fee2e2; color: #991b1b;",
            "neutral" => baseStyle + " background-color: #fef3c7; color: #92400e;",
            _ => baseStyle + " background-color: #e5e7eb; color: #1f2937;"
        };
    }

    void EditEntry(int id)
    {
        Nav.NavigateTo($"/entry/{id}");
    }
}