@page "/analytics"
@using System.Text.RegularExpressions
@inject DatabaseService Db

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <div class="mb-6">
        <MudText Typo="Typo.h4" Style="font-weight: 600;">Analytics</MudText>
        <MudText Typo="Typo.body1">Insights into your journaling patterns</MudText>
    </div>

    <MudPaper Elevation="0" Class="pa-6 mb-6" Style="border-radius: 16px; border: 1px solid #444;">
        <MudText Typo="Typo.h6" Class="mb-6" Style="font-weight: 600;">
            Mood Distribution
        </MudText>

        <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
            @if (_moodData.Any())
            {
                <MudChart ChartType="ChartType.Pie"
                          InputData="@_moodData.Select(x => (double)x.Value).ToArray()"
                          InputLabels="@_moodData.Select(x => $"{x.Key}: {x.Percentage}%").ToArray()"
                          Width="400px"
                          Height="400px"
                          ChartOptions="@(new ChartOptions { ChartPalette = _moodColors })" />
            }
            else
            {
                <MudText Typo="Typo.body1">No mood data available</MudText>
            }
        </div>
    </MudPaper>

    <MudGrid Spacing="4" Class="mb-6">
        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444; min-height: 450px;">
                <MudText Typo="Typo.h6" Class="mb-6" Style="font-weight: 600;">
                    Most Used Tags
                </MudText>

                @if (_tagData.Any())
                {
                    <div class="custom-tags-chart">
                        @foreach (var tag in _tagData)
                        {
                            <div class="tag-bar-item">
                                <div class="tag-bar-outer">
                                    <div class="tag-bar-inner" 
                                         style="height: @(GetBarHeight(tag.Count))%;">
                                        <span class="tag-count">@tag.Count</span>
                                    </div>
                                </div>
                                <MudText Typo="Typo.caption" Class="tag-label mt-2">@tag.Tag</MudText>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div style="display: flex; justify-content: center; align-items: center; height: 350px;">
                        <MudText Typo="Typo.body1">No tags data available</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444; min-height: 450px;">
                <MudText Typo="Typo.h6" Class="mb-6" Style="font-weight: 600;">
                    Word Count Trend
                </MudText>

                @if (_wordCountData.Any())
                {
                    <MudChart ChartType="ChartType.Line"
                             ChartSeries="@_wordCountSeries"
                             XAxisLabels="@_wordCountData.Select(x => x.Date.ToString("MM/dd")).ToArray()"
                             Width="100%"
                             Height="350px"
                             ChartOptions="@(new ChartOptions { 
                                 YAxisTicks = 50,
                                 LineStrokeWidth = 3,
                                 ChartPalette = ["#a855f7"]
                             })" />
                }
                else
                {
                    <div style="display: flex; justify-content: center; align-items: center; height: 350px;">
                        <MudText Typo="Typo.body1">No word count data available</MudText>
                    </div>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Spacing="4">
        <MudItem xs="12" md="4">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
                <MudText Typo="Typo.body2" Class="mb-2">Most Frequent Mood</MudText>
                <MudText Typo="Typo.h5" Style="font-weight: 600;">@_mostFrequentMood</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
                <MudText Typo="Typo.body2" Class="mb-2">Most Used Tag</MudText>
                <MudText Typo="Typo.h5" Style="font-weight: 600;">@_mostUsedTag</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; border: 1px solid #444;">
                <MudText Typo="Typo.body2" Class="mb-2">Average Word Count</MudText>
                <MudText Typo="Typo.h5" Style="font-weight: 600;">@_averageWordCount</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    // --- Chart Data States ---
    private List<MoodStats> _moodData = [];
    private List<TagStats> _tagData = [];
    private List<WordCountStats> _wordCountData = [];
    private List<ChartSeries> _wordCountSeries = [];
    private string[] _moodColors = [];

    // --- Summary State ---
    private string _mostFrequentMood = "N/A";
    private string _mostUsedTag = "N/A";
    private int _averageWordCount;
    private int _maxTagCount = 1;

    // --- Data Transfer Records ---
    public record MoodStats(string Key, int Value, int Percentage);
    public record TagStats(string Tag, int Count);
    public record WordCountStats(DateTime Date, int WordCount);

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalyticsDataAsync();
    }

    // Aggregates all journaling data and computes metrics for visualization.
    private async Task LoadAnalyticsDataAsync()
    {
        var entries = (await Db.GetAllEntriesAsync()).ToList();

        if (entries.Any())
        {
            CalculateMoodDistribution(entries);
            CalculateTagUsage(entries);
            CalculateWordCountTrend(entries);
            CalculateSummaryStats(entries);
        }
    }

    // Groups entries into Positive, Neutral, and Negative categories based on moods.
    private void CalculateMoodDistribution(List<JournalItem> entries)
    {
        var positiveMoods = new[] { "Happy", "Excited", "Grateful", "Peaceful", "Proud", "Hopeful" };
        var neutralMoods = new[] { "Calm", "Thoughtful", "Curious", "Neutral", "Content" };
        var negativeMoods = new[] { "Sad", "Anxious", "Angry", "Frustrated", "Tired", "Lonely" };

        var categorizedGroups = entries.GroupBy(e => {
            if (positiveMoods.Contains(e.PrimaryMood)) return "Positive";
            if (neutralMoods.Contains(e.PrimaryMood)) return "Neutral";
            if (negativeMoods.Contains(e.PrimaryMood)) return "Negative";
            return "Other";
        })
        .Select(g => new { Category = g.Key, Count = g.Count() })
        .OrderByDescending(x => x.Count)
        .ToList();

        var total = entries.Count;
        _moodData = categorizedGroups.Select(m => new MoodStats(
            m.Category,
            m.Count,
            (int)Math.Round((double)m.Count / total * 100)
        )).ToList();

        _moodColors = _moodData.Select(m => GetMoodColor(m.Key)).ToArray();
    }

    private static string GetMoodColor(string category) => category switch
    {
        "Positive" => "#10b981",
        "Neutral" => "#fbbf24",
        "Negative" => "#ef4444",
        _ => "#6b7280"
    };

    // Identifies the most frequently used tags for the bar chart.
    private void CalculateTagUsage(List<JournalItem> entries)
    {
        var allTags = entries.SelectMany(e => e.TagList).ToList();
        _tagData = allTags.GroupBy(t => t)
                          .Select(g => new TagStats(g.Key, g.Count()))
                          .OrderByDescending(t => t.Count)
                          .Take(6)
                          .ToList();

        if (_tagData.Any())
        {
            _maxTagCount = _tagData.Max(x => x.Count);
            if (_maxTagCount == 0) _maxTagCount = 1;
        }
    }

    // Maps word counts over time for the line chart trend.
    private void CalculateWordCountTrend(List<JournalItem> entries)
    {
        _wordCountData = entries.OrderBy(e => e.EntryDate)
                               .Select(e => new WordCountStats(
                                   e.EntryDate,
                                   CountWords(e.Content)
                               ))
                               .ToList();

        _wordCountSeries = [
            new ChartSeries
            {
                Name = "Word Count",
                Data = _wordCountData.Select(x => (double)x.WordCount).ToArray()
            }
        ];
    }

    // Utility to calculate word count for a single HTML content string.
    private static int CountWords(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return 0;
        return Regex.Replace(text, "<.*?>", string.Empty)
                    .Split([' ', '\n', '\r'], StringSplitOptions.RemoveEmptyEntries)
                    .Length;
    }

    // Computes high-level summary metrics.
    private void CalculateSummaryStats(List<JournalItem> entries)
    {
        var moodGroup = entries.GroupBy(e => e.PrimaryMood)
                               .OrderByDescending(g => g.Count())
                               .FirstOrDefault();
        _mostFrequentMood = moodGroup?.Key ?? "N/A";

        var allTags = entries.SelectMany(e => e.TagList).ToList();
        var tagGroup = allTags.GroupBy(t => t)
                             .OrderByDescending(g => g.Count())
                             .FirstOrDefault();
        _mostUsedTag = tagGroup?.Key ?? "N/A";

        var totalWords = entries.Sum(e => CountWords(e.Content));
        _averageWordCount = entries.Any() ? totalWords / entries.Count : 0;
    }

    // Calculates responsive height for the custom CSS bar chart.
    private int GetBarHeight(int count) => (int)Math.Max(10, (double)count / _maxTagCount * 100);
}
